<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="rahmatez github, rahmat ashari github - Contact" />
    <meta
      name="keywords"
      content="rahmatez, rahmat ashari, rahmatashari, github, rahmatashari, rahmat, ashari, contact" />
    <meta name="author" content="Rahmat Ashari" />
    <title>Contact - rahmatez Portfolio</title>

    <!-- favicon -->
    <link
      rel="shortcut icon"
      href="../assets/images/logo.ico"
      type="image/x-icon" />

    <!-- custom css link -->
    <link rel="stylesheet" href="../assets/css/style.css" />

    <!-- google font link -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet" />
  </head>

  <body>
    <main>
      <!-- SIDEBAR -->
      <aside class="sidebar" data-sidebar>
        <div class="sidebar-info">
          <figure class="avatar-box">
            <img
              src="../assets/images/my-avatar.png"
              alt="Rahmat Ashari"
              width="80" />
          </figure>

          <div class="info-content">
            <h1 class="name" title="Rahmat Ashari">Rahmat Ashari</h1>
            <p class="title">Web developer</p>
          </div>

          <button class="info_more-btn" data-sidebar-btn>
            <span>Show Contacts</span>
            <ion-icon name="chevron-down"></ion-icon>
          </button>
        </div>

        <div class="sidebar-info_more">
          <div class="separator"></div>

          <ul class="contacts-list">
            <li class="contact-item">
              <div class="icon-box">
                <ion-icon name="mail-outline"></ion-icon>
              </div>
              <div class="contact-info">
                <p class="contact-title">Email</p>
                <a href="mailto:rahmatezdev@gmail.com" class="contact-link">
                  rahmatezdev@gmail.com
                </a>
              </div>
            </li>

            <li class="contact-item">
              <div class="icon-box">
                <ion-icon name="phone-portrait-outline"></ion-icon>
              </div>
              <div class="contact-info">
                <p class="contact-title">Phone</p>
                <a href="tel:+6281393834186" class="contact-link">
                  +62 813 9383 4186
                </a>
              </div>
            </li>

            <li class="contact-item">
              <div class="icon-box">
                <ion-icon name="calendar-outline"></ion-icon>
              </div>
              <div class="contact-info">
                <p class="contact-title">Birthday</p>
                <time datetime="1982-06-23">28 November 2002</time>
              </div>
            </li>

            <li class="contact-item">
              <div class="icon-box">
                <ion-icon name="location-outline"></ion-icon>
              </div>
              <div class="contact-info">
                <p class="contact-title">Location</p>
                <address>Purwokerto, Central Java, ID</address>
              </div>
            </li>

            <li class="contact-item">
              <div class="icon-box">
                <ion-icon name="document-outline"></ion-icon>
              </div>
              <div class="contact-info">
                <p class="contact-title">CV</p>
                <a
                  href="../assets/cv/cv.pdf"
                  class="contact-link"
                  target="_blank">
                  Download CV
                </a>
              </div>
            </li>
          </ul>

          <div class="separator"></div>

          <ul class="social-list">
            <li class="social-item">
              <a href="https://github.com/rahmatez" class="social-link">
                <ion-icon name="logo-github"></ion-icon>
              </a>
            </li>
            <li class="social-item">
              <a href="https://twitter.com/rahmatez_" class="social-link">
                <ion-icon name="logo-twitter"></ion-icon>
              </a>
            </li>
            <li class="social-item">
              <a href="https://instagram.com/rahmatez_" class="social-link">
                <ion-icon name="logo-instagram"></ion-icon>
              </a>
            </li>
            <li class="social-item">
              <a
                href="https://www.linkedin.com/in/rahmat-ashari"
                class="social-link">
                <ion-icon name="logo-linkedin"></ion-icon>
              </a>
            </li>
          </ul>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="main-content">
        <!-- NAVBAR -->
        <nav class="navbar">
          <ul class="navbar-list">
            <li class="navbar-item">
              <a href="http://rahmatez.me/" class="navbar-link">About</a>
            </li>
            <li class="navbar-item">
              <a href="resume.html" class="navbar-link">Resume</a>
            </li>
            <li class="navbar-item">
              <a href="project.html" class="navbar-link">Project</a>
            </li>
            <li class="navbar-item">
              <a href="blog.html" class="navbar-link">Blog</a>
            </li>
            <li class="navbar-item">
              <a href="contact.html" class="navbar-link active">Contact</a>
            </li>
          </ul>
        </nav>

        <!-- CONTACT SECTION -->
        <article class="contact active" data-page="contact">
          <header
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
            <h2 class="h2 article-title">Contact</h2>
            <div></div>
          </header>

          <!-- MAP SECTION -->
          <section class="mapbox" data-mapbox>
            <figure>
              <iframe
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d4795.948071569345!2d109.24651767582718!3d-7.4352577732557865!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e655ea49d9f9885%3A0x62be0b6159700ec9!2sTelkom%20Purwokerto%20University!5e1!3m2!1sid!2sid!4v1736555549338!5m2!1sid!2sid"
                width="600"
                height="450"
                style="border: 0"
                allowfullscreen=""
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"></iframe>
            </figure>
          </section>

          <!-- CONTACT FORM SECTION -->
          <section class="contact-form">
            <h3 class="h3 form-title">Contact Form</h3>

            <form id="contactForm" class="form" data-form>
              <div class="input-wrapper">
                <!-- Input Name -->
                <input
                  type="text"
                  name="fullname"
                  class="form-input"
                  placeholder="Full name"
                  required
                  data-form-input />

                <!-- Input Email -->
                <input
                  type="email"
                  name="email"
                  class="form-input"
                  placeholder="Email address"
                  required
                  data-form-input />
              </div>

              <!-- Input Message -->
              <textarea
                name="message"
                class="form-input"
                placeholder="Your Message"
                required
                data-form-input></textarea>

              <!-- Submit Button -->
              <button
                class="form-btn"
                type="submit"
                data-form-btn
                id="sendMessageBtn">
                <ion-icon name="paper-plane"></ion-icon>
                <span>Send Message</span>
              </button>
            </form>
          </section>
        </article>
      </div>
    </main>

    <!-- custom js link -->
    <script src="../assets/js/script.js"></script>

    <!-- Load authentication system first -->
    <script src="../assets/js/auth-manager.js"></script>

    <!-- CRUD functionality - Make sure this loads before our form script -->
    <script src="../assets/js/crud-contact.js"></script>

    <!-- Debug script to check if scripts loaded properly -->
    <script>
      console.log(
        "Auth manager loaded:",
        typeof window.authManager !== "undefined"
      );
      console.log(
        "Contact manager loaded:",
        typeof window.contactManager !== "undefined"
      );
    </script>

    <!-- Enhanced Form validation script -->
    <script>
      // Validate form inputs
      function validateForm() {
        const name = document.querySelector("input[name='fullname']").value;
        const email = document.querySelector("input[name='email']").value;
        const message = document.querySelector(
          "textarea[name='message']"
        ).value;

        if (!name || !email || !message) {
          showNotification(
            "Please fill in all the fields before submitting.",
            "error"
          );
          return false;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showNotification("Please enter a valid email address.", "error");
          return false;
        }

        return true;
      }

      // Enhanced form submission
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize authentication UI
        updateAuthUI();

        // Listen for authentication changes
        window.addEventListener("authStateChanged", updateAuthUI);

        // Set up form submission handling
        const form = document.getElementById("contactForm");

        if (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault(); // Prevent the default form submission
            console.log("Form submitted");

            if (validateForm()) {
              console.log("Form is valid, submitting...");

              // Get form data
              const name = document.querySelector(
                "input[name='fullname']"
              ).value;
              const email = document.querySelector("input[name='email']").value;
              const message = document.querySelector(
                "textarea[name='message']"
              ).value;

              // Create message data object
              const messageData = {
                name: name,
                email: email,
                message: message,
              };

              try {
                // First check if contactManager is available
                if (!window.contactManager) {
                  throw new Error("Contact manager not available");
                }

                console.log(
                  "Using contactManager to send message:",
                  messageData
                );

                // Try to use contactManager first, fallback to localStorage
                window.contactManager
                  .createMessage(messageData)
                  .then((savedMessage) => {
                    console.log("Message saved successfully:", savedMessage);
                    showNotification("Message sent successfully!", "success");
                    form.reset();

                    // Debug check after sending
                    setTimeout(debugStorage, 500);
                  })
                  .catch((error) => {
                    console.error(
                      "Error with IndexedDB, using localStorage fallback:",
                      error
                    );

                    // Manually save to localStorage as failsafe
                    const newMessage = {
                      id: Date.now(),
                      ...messageData,
                      date: new Date().toISOString(),
                      status: "unread",
                    };

                    let messages = JSON.parse(
                      localStorage.getItem("contact_messages") || "[]"
                    );

                    messages.push(newMessage);
                    localStorage.setItem(
                      "contact_messages",
                      JSON.stringify(messages)
                    );

                    console.log(
                      "Message saved to localStorage directly:",
                      newMessage
                    );
                    showNotification("Message sent successfully!", "success");
                    form.reset();

                    // Debug check after sending
                    setTimeout(debugStorage, 500);
                  });
              } catch (error) {
                console.error("Error sending message:", error);
                showNotification(
                  "Something went wrong. Please try again.",
                  "error"
                );
              }
            }
          });
        }

        // Admin panel access (press Ctrl+Shift+M)
        document.addEventListener("keydown", function (e) {
          if (e.ctrlKey && e.shiftKey && e.key === "M") {
            displayMessages();
          }
        });
      });

      function updateAuthUI() {
        const loginBtn = document.getElementById("loginBtn");
        const adminBtn = document.getElementById("adminBtn");
        const dashboardBtn = document.getElementById("dashboardBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        if (window.authManager && window.authManager.isLoggedIn()) {
          loginBtn.style.display = "none";
          adminBtn.style.display = "inline-block";
          dashboardBtn.style.display = "inline-block";
          logoutBtn.style.display = "inline-block";
        } else {
          loginBtn.style.display = "inline-block";
          adminBtn.style.display = "none";
          dashboardBtn.style.display = "none";
          logoutBtn.style.display = "none";
          // Close contact admin panel if open
          if (typeof closeContactAdmin === "function") {
            closeContactAdmin();
          }
        }
      }

      // Create a simple localStorage-based contact manager as fallback
      if (!window.contactManager) {
        console.log("Creating fallback contact manager");
        window.contactManager = {
          createMessage: function (messageData) {
            return new Promise((resolve, reject) => {
              try {
                // Get existing messages or create empty array
                let messages = JSON.parse(
                  localStorage.getItem("contact_messages") || "[]"
                );

                // Add new message with ID and date
                const newMessage = {
                  id: Date.now(),
                  ...messageData,
                  date: new Date().toISOString(),
                  status: "unread",
                };

                messages.push(newMessage);
                localStorage.setItem(
                  "contact_messages",
                  JSON.stringify(messages)
                );

                resolve(newMessage);
              } catch (error) {
                reject(error);
              }
            });
          },
          getAllMessages: function () {
            return Promise.resolve(
              JSON.parse(localStorage.getItem("contact_messages") || "[]")
            );
          },
        };
      }

      // Define notification function to ensure it's always available on this page
      window.showNotification = function (message, type = "info") {
        const notification = document.createElement("div");
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          animation: slideIn 0.3s ease-out;
          background: ${
            type === "success"
              ? "#28a745"
              : type === "error"
              ? "#dc3545"
              : "#007bff"
          };
        `;

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease-out";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      };

      // Add CSS for animations if not already added
      if (!document.getElementById("notificationStyles")) {
        const style = document.createElement("style");
        style.id = "notificationStyles";
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }

      // Debug function to check storage
      function debugStorage() {
        const localMessages = JSON.parse(
          localStorage.getItem("contact_messages") || "[]"
        );
        console.log("DEBUG - localStorage messages:", localMessages);

        if (window.contactManager) {
          window.contactManager.getAllMessages().then((messages) => {
            console.log("DEBUG - contactManager messages:", messages);
          });
        }
      }

      // Call debug function on page load
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(debugStorage, 1000); // Delay to ensure everything is loaded
      });
    </script>

    <!-- ionicon link -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  </body>
</html>
